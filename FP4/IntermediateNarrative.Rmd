---
title: "Ocean Health"
subtitle: "Intermediate Narrative"
author: "Amelia Renner, Talia Chait, & Lorena Escobosa Alcantar"
date: "2023-04-11"
output: 
  html_document:
    code_folding: hide 
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
# Libraries
library(plyr)
library(lattice)
library(dplyr)
library(tidyr)
library(stringr)
library(ggplot2)
library(lubridate)
library(Rmisc)
library(ggrepel)
library(sf)
library(tidyverse)
library(ggplot2)
library(rnaturalearth)
library(rnaturalearthdata)
library(maps)
library(readr)
library(devtools)
library(ersst)
library(ggmap)
```

# Introduction

### Motivation

The world's oceans are our canary in the coal mine for climate change. The vastness and interconnection of these bodies provides great opportunity for research into how climate change affects the planet, including disproportionate impacts. The unique intersection of a global connector and multilevel ecosystem can inform how global changes affect different levels and areas of an ecosystem.

### Research Questions

1.  How is ocean health changing over time?
2.  How is ocean health changing due to climate change?

We looked at coral health, nutrient concentrations, animal health, temperature, and acidity as metrics to answer these questions.

# Findings

### Coral Reefs

***What is Coral Bleaching?***

Coral Bleaching is the act of corals losing their vibrant colors and turning white through being stressed. The leading cause of coral bleaching is climate change. This includes an increase in ocean temperature, overexposure to sunlight, or harmful nutrients from runoff or pollution. Any of these conditions could cause the coral to expel the symbiotic algae living in their tissues which in turn causes the corals to turn completely white - hence the bleaching term.

***Why is it important?***

It is important to remember that while corals are not necessarily "dead" from a coral bleaching event, it is still crucial to make sure they survive the bleaching events. Corals provide resources to many species that call the ocean their homes. By understanding the patterns in coral bleaching and bleaching severity, we can evaluate ocean health and understand what we can do to prevent more coral reefs from being bleached and ultimately prevent more damage to our oceans.

***Data, Visualizations, and Results***

Data was obtained from Harvard Dataverse [(link to data)](https://dataverse.harvard.edu/file.xhtml?persistentId=doi:10.7910/DVN/KUVQKY/PAMLRZ&version=1.4) which is a free data repository that is open to all researchers from any discipline (both inside and outside of Harvard University). It allows researchers to share, archive, cite, and access different data-sets. It was published to the resporitory in 2016 but has data from the mid 1800s.

Since this data-set is on corals, the ethical issues have to do with gathering information from marine life and and how much the data collection could cause harms. While the harms are minor, the benefits of this data being collected goes well beyond the health of the corals. This is because coral bleaching is an indicator of climate change so collecting data on the health of corals could have lasting impacts on reducing global warming.

```{r}
coralbleaching <- read.csv("Data/CoralBleaching.csv")
names(coralbleaching)
coralclean <- coralbleaching %>%
  group_by(REGION, YEAR) %>%
  dplyr::summarise(REGION, YEAR, mean(SEVERITY_CODE)) %>%
  unique()
world <- ne_countries(scale = "medium", returnclass = "sf")
class(world)
```

The following visualization shows the spread of the coral bleaching events. This map shows the world and the various coral bleaching events on top world outline. This map shows us where most of the events occur but not necessarily when or how. As seen in the graph, most of the coral bleaching events occur around the equator. This makes sense because the equator is where there is warmer water and a rise in ocean temperatures is one of the many causes of coral bleaching.

```{r fig.alt= "This is a map that shows the world and then the various coral bleaching events on top of the world. This suggests where most of the events occur but not necessarily when or how. As shown in the graph, most of the coral bleaching events occur around the equator in the warmer waters - which makes sense given the abckground of why coral bleaching occurs and its indicators."}
ggplot(data = world) +
  geom_sf() +
  geom_point(data = coralbleaching, aes(x = LON, y = LAT), size = 2,
        shape = 23, fill = "darkred") +
  ggplot2::coord_sf(xlim = c(-160, 160), ylim = c(-90, 90), expand = FALSE) +
  theme(plot.title = element_text(family = "mono", face = "bold", size = 12),
        plot.title.position = "plot",
        plot.caption = element_text(family = "mono"),
        plot.subtitle = element_text(family = "mono"),
        axis.title.y = element_text(family = "mono"),
        axis.title.x = element_text(family = "mono", vjust = 0.5)) +
  labs(title = "Coral Bleaching Events Around the World",
       y = "Latitude",
       x = "Longitude",
       caption = "Plot by Talia Chait | Data from Harvard Dataverse")
```

This is a scatter plot graph that shows the average severity code of the coral bleaching over time for the regions of Africa, Americas, Asia, Australia, Middle East, and Pacific. The original severity code variable is on a scale of -1 to 3 with -1 meaning unknown, 0 meaning no bleaching, 1 meaning low severity, 2 meaning medium severity, and 3 meaning high severity. Overall, the graph suggests that over time there has a been a change in coral bleaching severity with minimal differences between the regions. In order to explore more of the differences, we have to look into the total number of coral bleaching events per region by the severity of the bleaching events.

```{r, fig.alt="This is a scatter plot graph that shows the average severity code of the coral bleaching over time for the regions of Africa, Americas, Asia, Australia, Middle East, and Pacific. The original severity code variable is on a scale of -1 to 3 with -1 meaning unknown, 0 meaning no bleaching, 1 meaning low severity, 2 meaning medium severity, and 3 meaning high severity. Overall, the graph suggests that over time there has a been a change in coral bleaching severity with minimal differences between the regions."}
coralclean %>%
  filter(REGION != "NA") %>% 
  dplyr::rename("avgSevCode"="mean(SEVERITY_CODE)") %>%
  ggplot(aes(x = YEAR, y = avgSevCode, color = REGION)) +
  geom_point() +
  facet_wrap(vars(REGION)) + 
  theme_classic() +
  labs(x = "Year",
       y = "Average Severity Code",
       title = "Average Coral Bleaching Severity Code from 1963 to 2012",
       subtitle = "separated by the regions in the world",
       caption = "Plot by Talia Chait | Data from Harvard Dataverse",
       color = NULL) +
   theme(legend.position = "none",
        plot.title = element_text(family = "mono", face = "bold", size = 12, ),
        plot.title.position = "plot",
        plot.caption = element_text(family = "mono"),
        plot.subtitle = element_text(family = "mono"),
        axis.title.y = element_text(family = "mono"),
        axis.title.x = element_text(family = "mono", vjust = 0.5))
```

So, now that we know more about where coral bleaching events occur and why they occur, the next thing we need to understand is to what severity do they occur and in which region(s) is the severity the worst/best? In order to answer this question, a simple bar graph was created with the 6 regions on the Y axis and the number of coral bleaching events on the X axis. This graph shows that the Americas and Australia exceed the other 4 regions with total number of events of 2,000 plus events. Additionally, the break down of bleaching severity shows that the Americas have a larger amount of low bleaching events than Australia does while Australia has a larger number of high bleaching events than the Americas do.

```{r, fig.alt= "This is a bar plot that shows the 6 regions and the total number of bleaching events per region broken up by bleaching severity. The results show that the Americas and Australia exceed the other 4 regions with total number of events of 2,000 plus events. Additionally, the break down of bleaching severity shows that the Americas have a larger amount of low bleaching events than Australia does while Australia has a larger number of high bleaching events than the Americas do. "}
coral_countsev <- coralbleaching %>% 
  group_by(REGION, BLEACHING_SEVERITY) %>%
  count(REGION)

coral_countsev %>% 
  filter(REGION %in% c("Africa", "Americas", "Asia", "Australia", "Middle East", "Pacific")) %>%
  ggplot(mapping = aes(x= reorder(REGION, n), y = n, fill = BLEACHING_SEVERITY)) + 
  geom_col() +
  scale_fill_viridis_d() +
  coord_flip() + 
  theme_classic() +
  labs(title = "Total Number of Coral Bleaching Events per Region", 
       x = "", 
       y = "",
       legend = "",
       caption = "Plot by Talia Chait | Data from Harvard Dataverse") + 
   theme(plot.title = element_text(family = "mono", face = "bold", size = 12, ),
        plot.title.position = "plot",
        plot.caption = element_text(family = "mono"),
        plot.subtitle = element_text(family = "mono"),
        axis.text = element_text(family = "mono"), 
        legend.text = element_text(family = "mono"), 
        legend.title = element_text(family = "mono"))
```

***Resources***

[Data: Harvard Dataverse](https://dataverse.harvard.edu/file.xhtml?persistentId=doi:10.7910/DVN/KUVQKY/PAMLRZ&version=1.4)

[https://oceanservice.noaa.gov/facts/coral_bleach.html](https://oceanservice.noaa.gov/facts/coral_bleach.htm)

<https://www.greenpeace.org/usa/whats-killing-coral-reefs-and-how-can-we-stop-it/>

<https://education.nationalgeographic.org/resource/el-nino/>

### Ocean Chemistry

Ethical considerations when measuring ocean chemistry are especially important when considering the history of ocean research. Laboratory stations in Hawaii and on other indigenous lands have silenced indigenous voices and sequestered indigenous land in the name of research.

Oceans are also an interesting issue because of the concept of "international" waters. Researchers who are from Western countries have a legacy of dominating research and ocean waters. This legacy is important to remember to fuel accessibility and inclusivity in future research.

```{r}
# Reading Data
arctic <- read.csv("Data/ArcticLTER.csv")
california <- read.csv("Data/SantaBarbaraLTER.csv")
antcruise <- read.csv("Data/AntarcticaLTERcompiledData_Cruise_forEDI.csv")
cce<-read.csv("Data/CCEdata.csv")
hawaii <- read.csv("Data/Hawaii.csv")
chemssmall <- read.csv("Data/chemssmall.csv")
ctdsmall <- read.csv("Data/ctdsmall.csv")

# Data Cleaning 
california <- california %>%
  mutate(Date = str_sub(datetime_UTC, end = 10), 
         Year = str_sub(Date, end = 4), 
         Time = str_sub(datetime_UTC, start = 12)) %>%
  mutate(Date = ymd(Date), 
         Year = as.numeric(Year), 
         Time = hm(Time), 
         Month = str_sub(Date, start = 6, end = 7))

fullsbc2 <- chemssmall %>%
  full_join(ctdsmall, by = "decimal_year")

fullsbc <- fullsbc2 %>%
  dplyr::select(-yyyy.hyphen.mm.hyphen.dd.x, -hh.colon.mm.x, -yyyy.hyphen.mm.hyphen.dd.y, -hh.colon.mm.y) %>%
  mutate(DecimalYear = decimal_year, 
         Phosphate = phosphate, 
         Ammonium = ammonium, 
         Phosphorous = total_dissolved_phosphorus, 
         Nitrogen = total_dissolved_nitrogen, 
         pH = mean_pH) %>%
  dplyr::select(Actual_Depth_m, DecimalYear, Phosphate, Ammonium, Phosphorous, Ammonium, pH) %>%
  mutate(TempC = NA, 
         Silicate = NA,
         Nitrate = NA, 
         Nitrite = NA, 
         Station = "SBC")

cce2 <- cce %>%
  dplyr::select(Year, Temp..C., P04..µmol.L., SIO3..µmol.L., NO2..µmol.L., NO3..µmol.L.) %>%
  mutate(DecimalYear = Year, 
         TempC = Temp..C., 
         Phosphate = P04..µmol.L., 
         Silicate = SIO3..µmol.L., 
         Nitrite = NO2..µmol.L., 
         Nitrate = NO3..µmol.L.) %>%
  dplyr::select(DecimalYear, TempC, Phosphate, Silicate, Nitrite, Nitrate) %>%
  mutate(Actual_Depth_m = NA, 
         Ammonium = NA, 
         Phosphorous = NA, 
         Ammonium = NA, 
         pH = NA, 
         Station = "CCE")


fullCal <- fullsbc %>%
  rbind(cce2)

hawaii <- hawaii %>%
  mutate(BottleID = str_sub(BottleID.Date.Time.Pressure.pH, start = 2, end = 11), 
         Date = str_sub(BottleID.Date.Time.Pressure.pH, start = 14, end = 19), 
         Time = str_sub(BottleID.Date.Time.Pressure.pH, start = 22, end = 27), 
         Pressure = str_sub(BottleID.Date.Time.Pressure.pH, start = 30), 
         pH = str_sub(BottleID.Date.Time.Pressure.pH, start = -7, end = -3)) %>%
  mutate(Pressure = gsub(",.*","",Pressure), 
         Pressure = as.numeric(Pressure), 
         Date = mdy(Date), 
         Time = as.numeric(Time),
         pH = as.numeric(pH)) %>%
  mutate(Pressure = as.numeric(Pressure)) %>%
  mutate(Year = year(Date), 
         Month = month(Date)) %>%
  dplyr::select(-BottleID.Date.Time.Pressure.pH) %>%
  group_by(Year, Month) %>%
  dplyr::summarize(pH = mean(pH))

```

```{r}
# Ocean Temperatures
california %>%
  filter(temp_c > 0) %>%
  ggplot() + 
  geom_line(aes(x = Date, y = temp_c), ) + 
  geom_smooth(aes(x = Date, y = temp_c)) + 
  theme_classic() + 
  labs(y = "Temperature (ºC)", caption = "Source: https://portal.edirepository.org/nis/mapbrowse?packageid=knb-lter-sbc.6005.3#", title = "Average Daily Ocean Temperatures, 2011-2020, Santa Barbara Coastal LTER")
```

These data are from the Long Term Ecological Research (LTER) site in Santa Barbara, California. The site is funded through the National Science Foundation (NSF) and is dedicated to ecological research of near-shore ocean environments.

The above graph shows change in daily average ocean temperature in Santa Barbara, California, from April 2011 to December 2020. Please note that some days (ex. in mid-2011) do not have entries. Average temperature increases over time, beyond normal fluctuations for El Niño/La Niña variations. Summer 2018 and summer 2020 show especially high average daily temperatures.

```{r}
fullCal %>%
  mutate(Station = ifelse(Station == "SBC", "Near-Shore", "Off-Shore")) %>%
  filter(DecimalYear > 2000 & DecimalYear < 2020) %>%
  filter(Phosphate < 2.5) %>%
  ggplot() + 
#  geom_point(aes(x = DecimalYear, y = Phosphate, color = Station)) + 
  geom_line(aes(x = DecimalYear, y = Phosphate, color = Station), method ="loess", se = FALSE, size = 1) + 
  labs(x = "Year", y = "Phosphate (µmol/L)", title = "Oceanic Phosphate Concentrations at Santa Barbara, Near-Shore and Off-Shore", caption = "Data from SBC & CCE LTER Sites (https://lternet.edu/)") + 
  scale_color_manual(values = c("lightskyblue", "black")) +
  theme_classic()
```

These data are from the Santa Barbara (SBC) and California Coastal (CCE) LTER sites. They are roughly 100 miles in distance. SBC is a near-shore marine biome and CCE is a deeper ocean biome that experiences upwelling (deep ocean waters moving upward). The graph shows phosphate measurements taken over time at each location. Concentrations above 1.0 µmol/L in near-shore areas are elevated. It is additionally interesting to see peaks in off-shore areas in 2008 and 2013; phosphate concentrations tend to be more stable in off-shore areas.

```{r}
hawaii %>%
  ggplot() + 
  geom_point(aes(x = Year, y = pH)) + 
  geom_smooth(aes(x = Year, y = pH), method = "loess", se = FALSE) + 
  theme_classic() + 
  labs(title = "Ocean pH Measurements from Northeast of the Hawaiian Islands, 1992-2021", caption = "Data obtained via the Hawaii Ocean Time-series HOT-DOGS application; \nUniversity of Hawai'i at Mānoa. National Science Foundation Award # 1756517")
```

These data are from the Hawaii Ocean Time-series Data Organization & Graphical System (HOT-DOGS). pH is measured off the coast of the Hawaiian islands on scientific cruises. This graph shows a decrease on ocean pH over time; since ocean water contains a natural buffer system and pH is measured logarithmically, this acidification is significant.

### Animals

```{r}
fish <- read_csv(file = "Data/fish.csv")

 sst_download(2009:2021, 4:12, "./sst/", version = 5)
      x <- sst_load(2009:2021, 5:12, "./sst/", version = 5)
      filled.contour(x = x$lon, y = x$lat, z = x$sst[ , , 1])
seaTemps<-sst_dataframe(x)

medFish <- fish %>%
  mutate(lat = Decimal_latitude - Decimal_latitude %% 2) %>%
  mutate(lon = Decimal_longitude - Decimal_longitude %% 2) %>% 
  pivot_longer(cols = 14:28, names_to = "FishType",values_to = 'Count')

medSeaTemp <- seaTemps %>%
  filter(lat %in% (30:45) & lon %in% (0:35))
medSeaTemp

medJoin <- inner_join(medFish,medSeaTemp,by = c('lat' = 'lat','lon' = 'lon','Year' = 'year','Month' = 'month')) %>% mutate(TimePeriod = Year < 2015)

sumFish <- medJoin %>%
  group_by(Year,Month,Day,lat,lon,sst,FishType) %>%
  dplyr::summarize(AvgCount = mean(Count)) %>%
  mutate(DecimalDate = Year + (Month-1)/12)

fishTypes <- medJoin %>%
  filter(FishType %in% c('Coris_julis','Thalassoma_pavo'))

fishTypes %>%
  ggplot(aes(x = sst, y = Count, color = FishType)) + geom_point() + geom_smooth() + facet_grid(TimePeriod~Month)+ ylim(0,20)

fishTypes %>%
  distinct(lat,lon,Year,Month,Day,sst) %>%
  mutate(DecimalDate = Year + (Month-1)/12) %>%
  ggplot(aes(x = DecimalDate,y = sst )) + geom_point() + geom_smooth()

fishTypes %>%
  distinct(lat,lon,Year,Month,Day,sst) %>%
  mutate(DecimalDate = Year + (Month-1)/12) %>%
  mutate(latCat = cut(lat,3),longCat = cut(lon,3)) %>%
  ggplot(aes(x = DecimalDate,y = sst )) + geom_point() + geom_smooth() + facet_grid(latCat ~ longCat) + ylim(15,30)



fish_mod1 <- glm(Count ~ factor(Month)  + sst*factor(FishType),family = 'poisson',data = fishTypes %>% filter(Year < 2015))

fish_mod2 <- glm(Count ~ factor(Month)  + sst*factor(FishType),family = 'poisson',data = fishTypes %>% filter(Year >= 2015))

NewDat <- expand.grid(sst = seq(17.5,29,by=0.5),FishType = unique(fishTypes$FishType),Month = 7:11)
NewDat <- NewDat %>%
  mutate(pred_Before2015 = predict(fish_mod1,newdata=NewDat), pred_After2015 = predict(fish_mod2,newdata = NewDat)) %>% pivot_longer(starts_with('pred_'),names_to = 'TimePeriod',values_to = 'Pred' ) %>%
  mutate(TimePeriod = str_replace(TimePeriod,'pred_',''))
  

NewDat %>%
  ggplot(aes(x = sst, y = Pred, color = FishType)) + geom_point() + facet_grid(TimePeriod~Month) 


world <- get_stamenmap(
  bbox = c(left = -17.14, bottom = 25.80, right = 45.44, top = 51.29),
  maptype = "toner",
  zoom = 6
  )

tmp <- medSeaTemp %>% filter(year == 2015,month == 7) 
  ggmap(world) + geom_tile(data = tmp, aes(x = lon,y = lat , fill = sst),width = 2,height= 2)

tmp2 <- medSeaTemp %>% 
  filter(year == 2015,month == 7) %>% 
  dplyr::rename(Year = year, Month = month) %>% 
  mutate(FishType = 'Coris_julis') 

tmp2 <- tmp2 %>% mutate(pred = predict(fish_mod2,newdata = tmp2 ))

ggmap(world) + geom_tile(data = tmp2, aes(x = lon,y = lat , fill = pred),width = 2,height= 2)

with(
  fish_mod1,
  cbind(
    res.deviance = deviance,
    df = df.residual,
    p = pchisq(deviance, df.residual, lower.tail = FALSE)
  )
)

ggplot(data.frame(x=c(0:100)), aes(x)) +
    geom_point(aes(y=dpois(x, 30)), colour="purple")
```



# Future Directions

Our plan for the rest of the semester is available at [this](https://docs.google.com/document/d/1Vyv_E2dzXrgjAdC5JpM-8Q_aUGrZezzvCerlc1Srk9E/edit?usp=sharing) link.

# Work *(Cited)*

**Talia:** I created the website files needed to make a quarto website on github and made sure it all worked. I also set up qmd files for each of our parts of the project. I also edited the quarto.yml file to get the theme and navigation bar location that we wanted. Additionally, I started inputting my visualizations and some narrative text into my qmd file for the website. In terms of the intermediate presentation, I worked on the coral bleaching slide and the next steps slide. For the intermediate narrative, I worked on writing up the information for my section of coral bleaching.


**Amelia:** I made the website tab "Ocean Chemistry", which was then linked to our group's larger Quarto website. I created three visualizations for ocean chemistry that I included in my group's slides and on the Quarto website, with explanations in our group's .rmd file. I compiled my group's visualizations in R, formatted the .rmd document, wrote the "Description & motivation of research questions" section, and turned in the final compiled .rmd file. I also made the "Work *(Cited)*" pun for our contributions.*edit to add Talia had to work with the .Rmd at the end because her file wouldn't work on my machine 

**Lorena:**
